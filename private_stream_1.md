# private_stream_1数据格式

在[视频文件分段结构](./hiv_mp4_video.md#jump_pes_header)中，说明了所有private_stream_1 PES包都包括header和data两部分，也描述了header部分的含义。本文详细描述data部分含义。

private_stream_1的data部分包含了很多信息，到目前为止只有一小部分可以猜测出含义（GPS、加速度计等），剩余部分仍有待研究。

经过观察，在自定义的data部分，还有一个小header，后文称之为`private_header`。这个private_header之后的data称之为`private_data`，以和PES包的header和data作区分。因此整个PES包的data部分又可以分为两部分：

|  | 内容 |
| ---- | ---- |
| private_header | 包的类型，数据长度等 |
| private_data | 具体数据 |

## private_header

### 总体结构

所有private_stream_1包data的开始部分都有一个长度固定为`0x0C`的private_header。private_header的内容用**大端序**表示，与内部private_data不同。

其结构如下：

| 偏移量 | 字节数 | 类型 | 猜测含义 |
| ---- | ---- | ---- | ---- |
| 0x00 | 2 | uint16 | 大端序，与数据内容有关，后文称之为`pkt_id` |
| 0x02 | 2 | uint16 | 大端序，数据长度<sup>1</sup>的四分之一，后文称之为`pkt_len` |
| 0x04 | 2 | uint16 | 大端序，与数据内容有关，后文称之为`sub_pkt_id` |
| 0x06 | 6 | NA | 不明，总是`0x81 0x00 0x00 0xFF 0x00 0x00` |

<sup>1</sup> 数据长度，指的是从sub_pkt_id的第1个字节（含）一直到本个private_stream_1包末尾（含）的长度。此处记录了数据长度的四分之一，数据长度总是4的整倍数。

参考[PES_packet_length含义](./hiv_mp4_video.md#jump_pes_len)，可知 $`PES\_packet\_length = pkt\_len * 4 + 14`$

### pkt_id sub_pkt_id含义

pkt_id和sub_pkt_id不同，则private_data所含内容和结构也不同。经过观察，id与内容的对应如下表：

| pkt_id | sub_pkt_id | private_data内容 |
| ---- | ---- | ---- |
| 0x0007 | 0x0001 | 文字格式的加速度计数据，频率固定5Hz |
| 0x0802 | 0x0007 | 二进制格式GPS信息，频率固定1Hz</br>二进制格式加速度计数据，频率不固定 |
| 0x0802 | 0x0001 | 红绿灯、前车起步、GPS、加速度计等 |
| 0x0009 | 0x0001 | 不明 |

在所有的文件中只观察到了这些pkt_id与sub_pkt_id的组合。下面将按顺序分别对每一种组合详细描述。

## pkt_id=0x0007 sub_pkt_id=0x0001 文字格式加速度计

这类信息以ascii格式记录加速度计数据。可能因为十进制下数字长度会变化，因此这类数据长度也会变化。但是目前观察到长度只可能为`0x9C`或`0x8C`。

结构如下表。偏移量指的是从PES包data开始的偏移量。

| 偏移量 | 字节数 | 类型 | 猜测含义 |
| ---- | ---- | ---- | ---- |
| 0x00 | 12 |  | private_header |
| 0x0C | 4 | uint32 | 不明，总是`1` |
| 0x10 | 2 | uint16 | 不明，总是`2` |
| 0x12 | 14 | NA | 不明，总是`0xEE` |
| 0x20 | 4 | uint32 | 不明，总是`0x2C0` |
| 0x24 | 4 | uint32 | 不明，总是`0x240` |
| 0x28 | 2 | uint16 | private_data长度，总是`0x90`或`0x80` |
| 0x2A | 10 | NA | 不明，总是`0x00` |
| ---- | ---- | ---- | ---- |
| 0x34 | 2 | uint16 | 猜测为字符串1长度<sup>1</sup></br>通常为`0x38`或`0x30` |
| 0x36 | 6 | NA | 猜测为字符串1前分隔字节，总是`0x99` |
| 0x3C | 直到下一个`\0`（含） | char[] | 字符串1，时间戳 |
| 可变 | 直到字符串1长度结束 | NA | 猜测为字符串1末尾填充字节</br>通常为`0xAA`或`0x00` |
| ---- | ---- | ---- | ---- |
| 可变 | 2 | uint16 | 猜测为字符串2长度<sup>2</sup></br>通常为`0x38`或`0x30` |
| 可变 | 6 | NA | 猜测为字符串2前分隔字节，总是`0x99` |
| 可变 | 直到下一个`\0`（含） | char[] | 字符串2，加速度计信息 |
| 可变 | 直到包结尾 | NA | 猜测为字符串2末尾填充字节</br>通常为`0xAA`或`0xBB` |

<sup>1</sup> 字符串长度包括字符串长度、字符串前分隔字节、字符串、字符串后填充字节的总长度。

<sup>2</sup> 当包长度为`0x8C`时，字符串2的长度总是会比实际多`0x08`。因此这里猜测的含义仅作为参考。

### 时间戳

时间戳字符串的格式为：

```frmNum=x, timeStamp=y```

x为帧序数，整数。每两个同类数据包之间相隔200毫秒，因此x相差6（假设30fps）。

y为时间戳，整数，以毫秒为单位。y与PES_packet header中的PTS的关系为 $y = \frac{PTS}{90}$ 。每两个同类数据包之间相隔200毫秒，因此y相差200。

### 加速度计数据

加速度计字符串的格式为：

```g_rt=0 g_x=x g_y=y g_z=z```

g_rt总是为0。推测表示rt表示实时加速度，但是没有计算。

假定行车记录仪正常安装，摄像头朝前：

x为横向加速度，有符号整数，以 $cm \cdot s^{-2}$ 为单位，以左边为正方向。

y为前向加速度，有符号整数，以 $cm \cdot s^{-2}$ 为单位，以前方为正方向。

z为纵向加速度，有符号整数，以 $cm \cdot s^{-2}$ 为单位，以**下**方为正方向。
