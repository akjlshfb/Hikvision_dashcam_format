# hivXXXXX.mp4 文件

`hivXXXXX.mp4`是行车记录仪的记录文件。虽然扩展名为`.mp4`，但其中记录的数据不一定是视频，也有可能是照片数据。

根据十进制文件编号共有5位，以及index文件中表示文件编号的位置大多为二进制16位，推测最多可以支持65536个记录文件。实际的记录文件数量根据SD卡容量、分辨率、HDR等设置的不同一般为几百个。

根据观察，每个`hivXXXXX.mp4`文件的大小都为262144KB，也即 2^28 = 0x40_000_000 字节。如果存储视频，每个文件大约可以存储一分钟左右；存储照片则可以存储几百张照片。

## hivXXXXX.mp4 文件分类

经过观察，`hivXXXXX.mp4`文件可以分为三类：普通视频文件，紧急录像视频文件和抓拍文件。

普通视频文件记录正常的行车录像。同时也记录了录音、GPS、加速度计、红绿灯识别等信息。普通视频记录文件会被循环覆盖。

紧急录像文件结构与普通视频完全相同。当按下紧急录像按钮，语音识别到紧急录像指令或者加速度计检测到较大加速度时，会触发紧急录像。此时，这个文件会被标记为紧急录像，并且后续不会被循环覆盖。

当第一次按下抓拍按钮或者语音识别到抓拍指令时，会触发抓拍。此时，行车记录仪将会把一个`hivXXXXX.mp4`文件确定为存储抓拍用的记录文件。此文件不会被循环覆盖，且后续所有抓拍都将会存储到这个文件当中。

以上三类文件中，普通视频和紧急录像结构一致。所以后面仅区分视频记录文件和拍照记录文件的结构。

## hivXXXXX.mp4 文件总体结构

`hivXXXXX.mp4`文件大致符合[MPEG-PS](https://en.wikipedia.org/wiki/MPEG_program_stream)文件格式。MPEG-PS格式详见[ISO/IEC 13818-1](https://www.iso.org/standard/87619.html)标准。

总体来看，`hivXXXXX.mp4`文件由以下几部分组成：

|  | 起始位置 | 结束位置 | 长度 | 主要作用 |
| ---- | ---- | ---- | ---- |---- |
| 1 | 0x00000 | 0x0FFFF | 0x10000 | GPS轨迹信息 |
| 2 | 0x10000 | 0x1FFFF | 0x10000 | 不明 |
| 3 | 0x20000 | 0x3DFFF | 0x1E000 | 缩略图 |
| 4 | 0x3E000 | 0x3FFFF | 0x02000 | 不明 |
| 5 | 0x40000 | EOF | 文件剩余长度 | 视频/抓拍 |


