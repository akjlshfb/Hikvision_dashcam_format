# 视频文件结构

### 分段结构

如[记录文件总体结构](./hiv_mp4.md#jump_mp4_general)所述，每个记录文件都包括一个或多个完全相同的分段。每一分段存储一段视频。

对于视频文件，每个分段的5节所包含内容如下：

| 节数 | 相对分段开始位置 | 长度 | 主要内容 |
| ---- | ---- | ---- |---- |
| 1 | 0x00000 | 0x10000 | GPS记录 |
| 2 | 0x10000 | 0x10000 | 不明 |
| 3 | 0x20000 | 0x1E000 | 视频缩略图 |
| 4 | 0x3E000 | 0x02000 | 不明 |
| 5 | 0x40000 | 到这部分结尾 | 视频、音频、</br>GPS记录、加速度计记录、</br>红绿灯识别、前车起步识别 |

### 关于位置的说明

每个分段的开始位置可以从`indexXX.bin`目录文件中[找到](./index.md#jump_s4_video)。但要注意，目录文件中记录的是音视频数据开始的位置（也即第5段开始的位置）。若要得到分段开始位置，需要将目录文件中的每一分段开始位置减去`0x40000`。

每个分段的结束位置也可以在`indexXX.bin`目录文件中[找到](./index.md#jump_s4_video)。目录文件中的这一项在这里无需调整，可直接使用。

为简化说明，后文中出现的“位置”都指的是从分段开始处计算的位置。

## 第1节

本节位置和长度固定，为`0x0 - 0x10000`。

本节包括一个不符合标准的 private_stream_2 PES packet，主要包含视频对应的GPS轨迹信息。

### header

首先是`0x0 - 0x1F`。这一部分似乎是一个header。

| 偏移量 | 字节数 | 类型 | 猜测含义 |
| ---- | ---- | ---- | ---- |
| 0x00 | 3 | NA | packet_start_code_prefix，总是`0x00 0x00 0x01` |
| 0x01 | 1 | NA | stream_id，总是`0xBD`，表示private_stream_2 |
| 0x04 | 2 | uint16 | PES_packet_length，大端序，总是`0xFF8F`<sup>1</sup> |
| 0x06 | 2 | NA | 不明，总是`0xF8 0xFF` |
| 0x08 | 4 | NA | 不明，总是`0x00` |
| 0x0C | 4 | uint32 | 本片段长度<sup>2</sup> |
| 0x10 | 1 | NA | 不明，总是`0x01` |
| 0x11 | 1 | NA | 不明</br>0x00：正常录像</br>0x63：停车监控 |
| 0x12 | 1 | NA | 录像帧率（fps）：</br>30：正常录像<sup>3</sup></br>1：停车监控 |
| 0x13 | 1 | NA | 不明</br>0x13：正常录像</br>0x00：停车监控 |
| 0x14 | 4 | uint32 | 时间戳，本片段结束时间 |
| 0x18 | 4 | NA | 不明，总是`0x00` |
| 0x1C | 2 | uint16 | 后续GPS数据长度<sup>4</sup> |
| 0x1E | 1 | NA | 不明，总是`0x01` |
| 0x1F | 1 | NA | 不明，可能是某种校验和 |

<sup>1</sup> 根据标准，这个PES packet的长度不应是`0xFF8F`，而应是`0x10000 - 0x6 = 0xFFFA`。因此说本节是一个不符合标准的PES_packet。

<sup>2</sup> 这里的片段长度指的是第5段（音视频数据）的长度，不算前面4段总计`0x4000`的额外信息。

<sup>3</sup> 正常录像的帧率随设置而改变。

<sup>4</sup> 后续数据指的是后边以`0x30`为一组的GPS数据长度。因此这里除以`0x30`可以知道后面记录GPS数据点的个数。

### body

从`0x20`开始，以`0x30`为一组，代表了某一秒钟的视频与GPS信息。

GPS信息使用的是WGS84坐标系，其与国内使用的GCJ02坐标系有一定的偏差。如果想要把行车轨迹显示在地图上，需要注意地图所使用的坐标系是否同为WGS84，否则需要转换坐标系。

每组数据结构如下：

| 偏移量 | 字节数 | 类型 | 猜测含义 |
| ---- | ---- | ---- | ---- |
| 0x00 | 2 | NA | 不明，总是`0x78 0x56` |
| 0x02 | 2 | NA | 不明，对于视频文件，总是`0x01 0x00` |
| 0x04 | 4 | uint32 | 时间戳，开始时间 |
| 0x08 | 4 | uint32 | 时间戳处视频相对于音视频数据开始位置<sup>1</sup>的偏移量 |
| 0x0C | 4 | uint32 | 相对于上一行所述的位置，到下一个private_stream_1或pack_header的偏移量 |
| 0x10 | 4 | uint32 | 无符号经度，以百分之一***秒***为单位 |
| 0x14 | 4 | uint32 | 无符号纬度，以百分之一***秒***为单位 |
| 0x18 | 4 | uint32 | 车速，以千米每小时为单位 |
| 0x1C | 4 | uint32 | 速度方位角<sup>2</sup>，以百分之一***度***为单位 |
| 0x20 | 4 | uint32 | 高度<sup>3</sup>，以厘米为单位 |
| 0x24 | 1 | uint8 | 是否定位有效：</br>1：定位有效</br>0：定位无效 |
| 0x25 | 1 | char | 东经或西经：</br>`E`：东经</br>`W`：西经 |
| 0x26 | 1 | char | 北纬或南纬：</br>`N`：北纬</br>`S`：南纬 |
| 0x27 | 1 | NA | 不明，总是`0x00` |
| 0x28 | 8 | NA | 不明，总是`0x00` |

<sup>1</sup> “视频数据开始位置”指的是本段中第5节的开始位置，即本段开始位置之后的`0x40000`。

<sup>2</sup> 从天上向下看，从正北顺时针旋转的角度。

<sup>3</sup> 此处的高度指的是距离[GPS参考椭球面](https://zh.wikipedia.org/wiki/%E5%8F%82%E8%80%83%E6%A4%AD%E7%90%83)的椭球高，而非距离[大地水准面](https://zh.wikipedia.org/wiki/%E5%A4%A7%E5%9C%B0%E6%B0%B4%E5%87%86%E9%9D%A2)的正高。因此可能出现在海边但高度不为0的情况。


