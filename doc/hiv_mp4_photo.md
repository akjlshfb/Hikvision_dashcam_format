# 抓拍文件分段结构

如[记录文件总体结构](./hiv_mp4.md#jump_mp4_general)所述，每个记录文件都包括一个或多个完全相同的分段。在抓拍文件中，每一分段存储一组照片。`hivXXXXX.mp4`文件的总体结构应为：

| `hivXXXXX.mp4`文件 |
| :----: |
| 第1段 |
| 第2段 |
| ... |

本文讨论具体某一个分段内的结构。

对于抓拍文件，每个分段的5节所包含内容如下：

| 节数 | 相对分段开始位置 | 长度 | 主要内容 |
| ---- | ---- | ---- |---- |
| 1 | 0x00000 | 0x10000 | 一组中的照片数量；照片拍摄时间，在分段中的位置 |
| 2 | 0x10000 | 0x10000 | 每张照片触发拍照的原因 |
| 3 | 0x20000 | 0x1E000 | 不明 |
| 4 | 0x3E000 | 0x02000 | 不明 |
| 5 | 0x40000 | 到本个分段结尾 | 二进制照片数据 |

### 关于位置的说明

一个`hivXXXXX.mp4`文件可包含多个分段。

每个分段照片数据的开始位置`seg_data_start_pos`可以在`indexXX.bin`目录文件第四段中[找到](./index.md#jump_s4_photo)。但要注意，照片数据开始的位置（也即第5节开始的位置）并不是分段的开始位置。若要得到分段的开始位置，需要将`seg_data_start_pos`**减**去`0x40000`。

每个分段的结束位置也可以在`indexXX.bin`目录文件第四段中[找到](./index.md#jump_s4_photo)。目录文件中的这一项在这里无需调整，可直接使用。

**为简化说明，后文中出现的“位置”都默认是从分段开始处计算的位置，而非从文件开始处计算。**

## 第1节

本节开始位置固定为`0x0`，观察知其长度为`0x10000`。

本节包括一个不符合标准的 private_stream_2 PES packet，主要包含这一分段中的照片数量，每个照片拍摄时间和在分段中的位置。

本节总体结构：

|  | 节内偏移量 | 字节数 | 主要内容 |
| ---- | ---- | ---- | ---- |
| header | 0x00 | 0x20 | 本组照片总体信息 |
| body | 0x20 | 0x30 | 第1张照片大小和位置 |
|  | 0x50 | 0x30 | 第2张照片大小和位置 |
|  | 0x80 | 0x30 | 第3张照片大小和位置 |
|  | ... | 0x30 | ... |

### header

本节内`0x0 - 0x1F`的内容似乎是一个header。

| 偏移量 | 字节数 | 类型 | 猜测含义 |
| ---- | ---- | ---- | ---- |
| 0x00 | 3 | NA | packet_start_code_prefix，总是`0x00 0x00 0x01` |
| 0x03 | 1 | NA | stream_id，总是`0xBF`，表示private_stream_2 |
| 0x04 | 2 | uint16 | PES_packet_length，大端序，总是`0xFF8F`<sup>1</sup> |
| 0x06 | 2 | NA | 不明，总是`0xF8 0xFF` |
| 0x08 | 4 | NA | 不明，总是`0x00` |
| 0x0C | 4 | uint32 | 本分段照片数据所占长度<sup>2</sup></br>后文记为`photo_group_len` |
| 0x10 | 4 | NA | 不明，总是`0x00` |
| 0x14 | 4 | uint32 | 时间戳，最后一张照片拍摄时间 |
| 0x18 | 4 | NA | 不明，总是`0x00` |
| 0x1C | 2 | uint16 | 后续body内数据长度<sup>3</sup> |
| 0x1E | 1 | NA | 不明，总是`0x01` |
| 0x1F | 1 | NA | 不明，可能是某种校验和 |

<sup>1</sup> PES_packet_length仍属于MPEG-PS标准，用大端序表示；后续内容属于自定义数据，观察发现是小端序。根据标准，这个PES packet的长度不应是`0xFF8F`，而应是`0x10000 - 0x6 = 0xFFFA`。因此说本节是一个不符合标准的PES_packet。

<sup>2</sup> 这里指的是第5段（照片数据）所占用的长度，不算前面4段总计`0x4000`的额外信息。观察发现第五段结束之后就是下一个文件分段，中间没有观察到过间隔。但是不推荐用这里的长度推算文件中下一分段的开始位置。推荐用`indexXX.bin`中的`seg_data_start_pos`推算。

<sup>3</sup> 后续数据指的是header后以`0x30`为一组的照片数据长度。因此这里除以`0x30`可以知道这一分段内记录的照片数量。后文记为`seg_photo_num`。

### body

接下来的数据以`0x30`为一组，代表了分段内每张照片的大小和位置。共有`seg_photo_num`组数据。

对第`n`组长`0x30`的数据，结构如下：

| 偏移量 | 字节数 | 类型 | 猜测含义 |
| ---- | ---- | ---- | ---- |
| 0x00 | 2 | NA | 不明，总是`0x78 0x56` |
| 0x02 | 2 | NA | 不明，对于照片文件，总是`0x03 0x00` |
| 0x04 | 4 | uint32 | 时间戳，拍照时间 |
| 0x08 | 4 | uint32 | 第`n`张照片在文件中相对于照片数据开始位置<sup>1</sup>的偏移量</br>后文以`photo_offset[n]`表示 |
| 0x0C | 4 | uint32 | 第`n`张照片在文件中所占长度<sup>2</sup></br>后文以`data_len[n]`表示 |
| 0x10 | 24 | NA | 不明，总是`0x00` |
| 0x28 | 4 | uint32 | 第`n`张照片大小，字节为单位</br>后文以`photo_len[n]`表示 |
| 0x2C | 4 | uint32 | 第`n`张缩略图大小，字节为单位</br>后文以`thumb_len[n]`表示 |

<sup>1</sup> “照片数据开始位置”即`seg_data_start_pos`，指的是本分段中第5节的开始位置，在本分段开始位置之后的`0x40000`。

<sup>2</sup> 所占长度并不等于照片加上缩略图的大小。在第5节每张照片和缩略图数据之后有很多`0x00`填充。这样使得`data_len[n]`总是`0x10000`的整数倍，但是填充的`0x00`的长度可能大于`0x10000`。

后续至第2节开始前数据都为`0x00`。

## 第2节

本节开始位置固定为`0x10000`，观察知其长度为`0x10000`。

本节包括一个不符合标准的 private_stream_2 PES packet。本节主要包括了每张照片的拍照时间和触发拍照的原因。

本节总体结构：

|  | 节内偏移量 | 字节数 | 内容 |
| ---- | ---- | ---- | ---- |
| header | 0x00 | 0x20 | 后续body内数据长度 |
| body | 0x20 | 0x10 | 分段内第1张照片拍照原因 |
|  | 0x30 | 0x10 | 分段内第2张照片拍照原因 |
|  | ... | 0x10 | ... |

### header

本节内`0x0 - 0x1F`的内容似乎是一个header。

| 偏移量 | 字节数 | 类型 | 猜测含义 |
| ---- | ---- | ---- | ---- |
| 0x00 | 3 | NA | packet_start_code_prefix，总是`0x00 0x00 0x01` |
| 0x01 | 1 | NA | stream_id，总是`0xBF`，表示private_stream_2 |
| 0x04 | 2 | uint16 | PES_packet_length，大端序，总是`0xFF8F`<sup>1</sup> |
| 0x06 | 2 | NA | 不明，总是`0xF8 0x7F` |
| 0x08 | 20 | NA | 不明，总是`0x00` |
| 0x1C | 2 | uint16 | 后续body内数据长度<sup>2</sup> |
| 0x1E | 1 | NA | 不明，总是`0x02` |
| 0x1F | 1 | NA | 不明，可能是某种校验和，总是`0xC5` |

<sup>1</sup> 同第1节，此处长度不正确，因此第2节包含的PES包也不符合标准。

<sup>2</sup> 后续每条数据长度为`0x10`，因此可根据长度确定后续数据条数。此数目总是等于`seg_photo_num`。

如果某一分段视频里面没有紧急录像，则此处的长度应为`0x00`，后面数据体里面也全为`0x00`。

### body

接下来每条数据长`0x10`，代表了一张照片的拍照原因。共有`seg_photo_num`条数据。

对每条长`0x10`的数据：

| 偏移量 | 字节数 | 类型 | 猜测含义 |
| ---- | ---- | ---- | ---- |
| 0x00 | 2 | NA | 不明，总是`0x78 0x56` |
| 0x02 | 2 | uint16 | 拍照原因</br>0x03：由语音“我要拍照”触发拍摄<br/>0x67：由停车监控下检测到震动触发拍摄 |
| 0x04 | 4 | uint32 | 时间戳，拍照时间 |
| 0x08 | 8 | NA | 总是`0x00` |

后续至第3节开始前数据都为`0x00`。

## 第3节

本节开始位置固定为`0x20000`，观察知其长度为`0x1E000`。

本节包括一个不符合标准的 private_stream_2 PES packet，含义不明。

本节总体结构：

|  | 节内偏移量 | 字节数 | 内容 |
| ---- | ---- | ---- | ---- |
| header | 0x00 | 0x20 | 不明 |

### header

本节内容似乎只包含`0x0 - 0x1F`处的header。

| 偏移量 | 字节数 | 类型 | 猜测含义 |
| ---- | ---- | ---- | ---- |
| 0x00 | 3 | NA | packet_start_code_prefix，总是`0x00 0x00 0x01` |
| 0x01 | 1 | NA | stream_id，总是`0xBF`，表示private_stream_2 |
| 0x04 | 2 | uint16 | PES_packet_length，大端序，总是`0xFF8F`<sup>1</sup> |
| 0x06 | 2 | NA | 不明，总是`0xF8 0xFF` |
| 0x08 | 22 | NA | 不明，总是`0x00` |
| 0x1E | 1 | NA | 不明，总是`0x04` |
| 0x1F | 1 | NA | 不明，可能是某种校验和，总是`0x45` |

<sup>1</sup> 同第1节，此处长度不正确，因此第3节包含的PES包也不符合标准。

后续至第4节开始前数据都为`0x00`。

## 第4节

本节开始位置固定为`0x3E0000`，观察知其长度为`0x2000`。

本节包括一个不符合标准的 private_stream_2 PES packet，含义不明。

本节总体结构：

|  | 节内偏移量 | 字节数 | 内容 |
| ---- | ---- | ---- | ---- |
| header | 0x00 | 0x20 | 不明 |

### header

本节内容似乎只包含`0x0 - 0x1F`处的header。

| 偏移量 | 字节数 | 类型 | 猜测含义 |
| ---- | ---- | ---- | ---- |
| 0x00 | 3 | NA | packet_start_code_prefix，总是`0x00 0x00 0x01` |
| 0x01 | 1 | NA | stream_id，总是`0xBF`，表示private_stream_2 |
| 0x04 | 2 | uint16 | PES_packet_length，大端序，总是`0xFF8F`<sup>1</sup> |
| 0x06 | 2 | NA | 不明，总是`0xF8 0x1F` |
| 0x08 | 22 | NA | 不明，总是`0x00` |
| 0x1E | 1 | NA | 不明，总是`0x07` |
| 0x1F | 1 | NA | 不明，可能是某种校验和，总是`0x65` |

<sup>1</sup> 同第1节，此处长度不正确，因此第3节包含的PES包也不符合标准。

后续至第5节开始前数据都为`0x00`。

## 第5节

本节开始位置固定为`0x400000`，内容为多张照片。其长度可变，由[第1节](#第1节)的header内`photo_group_len`字段确定。

本节内，按照[第1节](#第1节)内确定的照片数量、每张照片的偏移量和大小，可以分为`seg_photo_num`组，每一组中包括了一张照片和缩略图的数据。

本节总体结构：

| 组数 | 节内偏移量 | 字节数 | 内容 |
| ---- | ---- | ---- | ---- |
| 0 | photo_offset[0] | data_len[0] | 片段内第1张照片和缩略图数据 |
| 1 | photo_offset[1] | data_len[1] | 片段内第2张照片和缩略图数据 |
| ... | ... | ... | ... |
| `seg_photo_num-1` | photo_offset[`seg_photo_num-1`] | data_len[`seg_photo_num-1`] | 片段内第`seg_photo_num`张照片和缩略图数据 |

### 一张照片及缩略图的数据

第`n`组数据结构如下：

| 组内偏移量 | 字节数 | 内容 |
| ---- | ---- | ---- |
| 0x0 | `photo_len[n]` | 全尺寸照片数据 |
| `photo_len[n]` | `thumb_len[n]` | 缩略图数据 |
| `photo_len[n]+thumb_len[n]` | 到这一组结尾 | 总是`0x00` |

其中，照片和缩略图都是jpeg格式的图像。

<br/><br/>
返回[hivXXXXX.mp4 文件简介](./hiv_mp4.md#jump_mp4_general)
