# indexXX.bin 文件结构

 `index00.bin`、`index01.bin`和`index02.bin`这三个文件的结构完全相同。根据目前对文件最后修改时间的观察，猜测`index00.bin`记录着最新的目录信息。开机时会把`index00.bin`备份至`index02.bin`。关机前，会把`index00.bin`备份到`index01.bin`。

即，取出SD卡用电脑读取时，`index00.bin`与`index01.bin`的内容相同，而`index02.bin`中存储的是过时的数据。因此，只需要分析记录最新数据的`index00.bin`。

index文件总体结构大致如下：

| 段数 | 作用 |
| ---- | ---- |
| 1 | 总体信息 |
| 2 | 每一个`hivXXXXX.mp4`记录文件总体信息 |
| 3 | 不明 |
| 4 | 每一个`hivXXXXX.mp4`记录文件中每一段视频/每一张抓拍的信息 |

## 第一段

本段位置固定为`0x0 - 0x3af`。在这一段中，按照长度`0x30`的内容为一节，分为19节。结构大致如下：

| 节数 | 主要包含信息 |
| ---- | ---- |
| 1 | `hivXXXXX.mp4`记录文件数量 |
| 2 | 当前写入的记录文件 |
| 3 | 记录抓拍的记录文件 |
| 4-19 | 空白 |

### 第1节 0x0 - 0x29

此节主要记录SD卡中共有多少个`hivXXXXX.mp4`记录文件。

| 偏移量 | 字节数 | 类型 | 猜测含义 |
| ---- | ---- | ---- | ---- |
| 0x00 | 4 | uint32 | 不明，但会随时间增长 |
| 0x04 | 8 | NA | 不明 |
| 0x0C | 2 | uint16 | SD卡目录中`hivXXXXX.mp4`文件数量 |
| 0x0E | 10 | NA | 不明 |
| 0x18 | 2 | NA | 不明，总是`0xFF 0xFF` |
| 0x1A | 22 | NA | 不明，总是`0x00` |

### 第2节 0x30 - 0x59

此节主要记录关机前正在写入的`hivXXXXX.mp4`文件。假设该文件编号为`XXXXX`。

| 偏移量 | 字节数 | 类型 | 猜测含义 |
| ---- | ---- | ---- | ---- |
| 0x00 | 2 | uint16 | 关机时正在写入的视频文件编号`XXXXX` |
| 0x02 | 2 | NA | 不明，总是`0x00 0x00` |
| 0x04 | 4 | uint32 | 时间戳，该视频的开始时间 |
| 0x08 | 4 | uint32 | 时间戳，该视频的结束时间（即关机时间） |
| 0x0C | 12 | NA | 不明，总是`0x00` |
| 0x18 | 2 | NA | 不明，总是`0xFF 0xFF` |
| 0x1A | 22 | NA | 不明，总是`0x00` |

### <span id="jump_s1_photo">第3节 0x60 - 0x89</span>

抓拍的照片会单独保存在一个`hivXXXXX.mp4`文件中。此节主要该抓拍记录文件的信息。

| 偏移量 | 字节数 | 类型 | 猜测含义 |
| ---- | ---- | ---- | ---- |
| 0x00 | 2 | uint16 | 用于记录抓拍的记录文件编号`XXXXX` |
| 0x02 | 2 | uint16 | 照片记录文件的分段<sup>1</sup>数量</br>分段数量后文记为`seg_num` |
| 0x04 | 4 | uint | 时间戳，开箱后首次抓拍时间 |
| 0x08 | 4 | uint | 时间戳，最后一次抓拍的时间 |
| 0x0C | 4 | NA | 不明 |
| 0x10 | 2 | uint16 | 猜测为该文件支持的最大拍照数量 |
| 0x12 | 6 | NA | 不明，总是`0x00` |
| 0x18 | 2 | NA | 不明，总是`0xFF 0xFF` |
| 0x1A | 22 | NA | 不明，总是`0x00` |

<sup>1</sup> 照片记录文件中，每个[分段](./hiv_mp4.md#jump_mp4_general)内有一**组**照片，因此这里也是照片的**组**数。

### 第4-19节

这些节似乎没有被用到。

| 偏移量 | 字节数 | 类型 | 猜测含义 |
| ---- | ---- | ---- | ---- |
| 0x00 | 2 | NA | 不明，总是`0xFF 0xFF` |
| 0x02 | 22 | NA | 不明，总是`0x00` |
| 0x18 | 2 | NA | 不明，总是`0xFF 0xFF` |
| 0x1A | 22 | NA | 不明，总是`0x00` |

## 第二段

本段位置固定为`0x4b0 - 0x4ff`。含义不明。

| 偏移量 | 字节数 | 类型 | 猜测含义 |
| ---- | ---- | ---- | ---- |
| 0x00 | 76 | NA | 不明，总是`0x00` |
| 0x4C | 4 | uint32 | 不明，可能是视频总长度，以秒为单位 |

## 第三段

本段从`0x500`开始。

在这一段中，按照长度`0x20`为一节，节的数量和`hivXXXXX.mp4`记录文件数量相同，每一节都对应了一个记录文件。因为视频帧率、分辨率、HDR、SD卡容量等设置不同导致记录文件数量也会不同。因此这一段的长度不固定。

例如，有234个`hivXXXXX.mp4`记录文件时，本段位置为0x500 - 0x223f。

本段大致结构如下：

| 节数 | 偏移量 | 长度 | 主要包含信息 |
| ---- | ---- | ---- | ---- |
| 1 | 0x00 | 0x20 | `hiv00000.mp4`记录文件信息 |
| 2 | 0x20 | 0x20 | `hiv00001.mp4`记录文件信息 |
| 3 | 0x40 | 0x20 | `hiv00002.mp4`记录文件信息 |
| ... | ... | 0x20 | ... |

至于其中长度为`0x20`的每一节，按照对应的记录文件是视频文件还是抓拍文件，内容含义有所不同。下面分别描述。

### <span id="jump_s3_video">视频记录文件</span>

| 偏移量 | 字节数 | 类型 | 猜测含义 |
| ---- | ---- | ---- | ---- |
| 0x00 | 4 | uint32 | 对应的`hivXXXXX.mp4`文件序号`XXXXX` |
| 0x04 | 2 | uint16 | 0：未写入完成（如正在使用）<br/>1：写入完成 |
| 0x06 | 2 | uint16 | 文件中包含的分段<sup>1</sup>数量-1</br>分段数量后文记为`seg_num` |
| 0x08 | 4 | uint32 | 时间戳，该视频文件的开始时间 |
| 0x0C | 4 | uint32 | 时间戳，该视频文件的结束时间 |
| 0x10 | 2 | uint16 | 此文件用来记录<br/>0：正常行车视频<br/>1：紧急录像<br/>2：当前正在写入的文件/抓拍文件 |
| 0x12 | 2 | NA | 不明 |
| 0x14 | 4 | NA | 不明，总是`0x00` |
| 0x18 | 4 | uint32 | 0x0：不明，常见<br/>0x2：不明，仅在紧急录像中出现<br/>0x64：按下紧急录像按钮开始的紧急录像 |
| 0x1C | 4 | NA | 不明，总是`0x00` |

<sup>1</sup> 视频文件中，观察到每个[分段](./hiv_mp4.md#jump_mp4_general)包含一个视频。

### <span id="jump_s3_photo">抓拍记录文件</span>

| 偏移量 | 字节数 | 类型 | 猜测含义 |
| ---- | ---- | ---- | ---- |
| 0x00 | 4 | uint32 | 对应的`hivXXXXX.mp4`文件序号`XXXXX` |
| 0x04 | 12 | NA | 不明，总是`0x00` |
| 0x10 | 2 | uint16 | 此文件用来记录<br/>0：正常行车视频<br/>1：紧急录像<br/>2：当前正在写入的文件/抓拍文件<br/>抓拍文件中总是2 |
| 0x12 | 14 | NA | 不明，总是`0x00` |

## 第四段

本段长度与位置不固定，随记录文件数量而变化。

### 长度为`0x5000`的节

本段从上一段结束位置开始。在这一段中，按照长度`0x5000`为一节，节的数量和`hivXXXXX.mp4`记录文件数量相同，每一节都对应了一个记录文件。每一节的内容为某个记录文件内各个分段的信息。

因为记录文件数量不确定，因此本节位置和长度可变。

第四段结构可以表示为：

| 节数 | 偏移量 | 长度 | 包含信息 |
| ---- | ---- | ---- | ---- |
| 0 | 0x0000 | 0x5000 | `hiv00000.mp4`各分段信息 |
| 1 | 0x5000 | 0x5000 | `hiv00001.mp4`各分段信息 |
| ... | ... | 0x5000 | ... |
| n | 0x5000 * n | 0x5000 | 第n个`hivXXXXX.mp4`文件各分段信息 |
| ... | ... | 0x5000 | ... |

### 长度为`0x50`的组

在长度为`0x5000`的节中，按照长度`0x50`又可以分为若干组。每一组对应了记录文件中的一个分段。照片文件的分段数量可以从[第一段第3节](#jump_s1_photo)的`seg_num`字段获得，视频文件的分段数量可以从[第三段对应视频文件的节](jump_s3_video)的`seg_num`字段获得。

每一个长度为`0x5000`的节的结构可以表示为：

| 组数 | 偏移量 | 长度 | 包含信息 |
| ---- | ---- | ---- | ---- |
| 0 | 0x00 | 0x50 | 某个记录文件第1个分段信息 |
| 1 | 0x00 | 0x50 | 某个记录文件第2个分段信息 |
| ... | ... | 0x50 | ... |
| n | 0x50 * n | 0x50 | 某个记录文件第`n+1`个分段信息 |
| ... | ... | 0x50 | ... |

每个长度为`0x50`的组，根据所其所在的节对应的文件是视频文件还是抓拍文件，含义有所不同，下面分别描述。

### <span id="jump_s4_video">视频记录文件</span>

一个视频记录文件中会分为不同片段记录视频。这是因为某一文件的记录范围内可能多次开关机，有多个紧急录像，或者进入/离开了停车监控模式。

对于视频文件，每一个长度为`0x50`的组对应了一个视频文件的分段。每个分段内包括了一个视频片段。其结构如下：

| 偏移量 | 字节数 | 类型 | 猜测含义 |
| ---- | ---- | ---- | ---- |
| 0x00 | 1 | uint8 | 本组信息类型<br/>0：视频片段信息<br/>2：抓拍信息<br/>视频文件总是0 |
| 0x01 | 1 | NA | 不明，通常为`0x00`，偶尔为`0x01` |
| 0x02 | 2 | NA | 不明，总是`0x00` |
| 0x04 | 4 | uint32 | 视频类型<br/>0x13：普通行车记录<br/>0x00：停车监控 |
| 0x08 | 4 | uint32 | 时间戳，视频片段开始时间 |
| 0x0C | 4 | NA | 不明，总是`0x00` |
| 0x10 | 4 | uint32 | 时间戳，视频片段结束时间 |
| 0x14 | 20 | NA | 不明，总是`0x00` |
| 0x28 | 4 | uint32 | 本分段中视频数据<sup>1</sup>在`hivXXXXX.mp4`文件中的开始位置（含）<br/>后文中称之为`seg_data_start_pos` |
| 0x2C | 4 | uint32 | 本分段在`hivXXXXX.mp4`文件中的结束位置（不含） |
| 0x30 | 1 | NA | 猜测<br/>0：本视频片段自然结束<br/>1：本视频片段因关机而结束 |
| 0x31 | 1 | uint8 | 录像帧率，以帧每秒为单位<br/>30：行车记录（可能因设置而不同）<br/>1：停车监控 |
| 0x32 | 1 | NA | 猜测<br/>0x0：行车记录<br/>0x63：停车监控 |
| 0x33 | 1 | NA | 不明，总是`0x01` |
| 0x34 | 4 | NA | 不明，总是`0x00` |
| 0x38 | 4 | NA | 不明，通常为`0x00`，偶尔为`0x64`或`0x02` |
| 0x3C | 12 | NA | 不明，总是`0x00` |
| 0x48 | 4 | NA | 不明，总是`0x00 0x00 0x00 0x10` |
| 0x4C | 4 | NA | 不明，总是`0x00 0x00 0x00 0x10` |

<sup>1</sup> 在`hivXXXXX.mp4`文件中，在音视频数据之前，还有4节总长度为`0x40000`的其他数据。详见[视频文件结构](./hiv_mp4_video.md)。

[在index文件第三段中提到过](#jump_s3_video)，第三段中记录了每一个视频文件中的分段数量`seg_num`，但是此处可能有多于`seg_num`个组都包含数据。这是由于某个视频文件在被覆盖之前曾经记录过更多段视频导致的。

例如，一个视频文件曾经记录过5段视频，则此处的前5组都有数据。当这个视频文件被循环录像覆盖后，仅用来记录了1段录像。这时，新车记录仪只会覆盖掉第1组的数据，后4组不作修改。因此他们应该被视为无效信息。

### <span id="jump_s4_photo">抓拍记录文件</span>

抓拍记录文件中会分为不同片段记录多组照片。`indexXX.bin`文件中仅仅记录了照片的组数，而没有记录照片的总数量。照片的数量需要到`hivXXXXX.mp4`文件中计算。

与视频记录文件对应的结构类似，抓拍记录文件也是以0x50为一组。此处每一组二进制数据对应了抓拍文件的一个分段。每个分段内有一组照片。

对0x50长度的每一组：

| 偏移量 | 字节数 | 类型 | 猜测含义 |
| ---- | ---- | ---- | ---- |
| 0x00 | 1 | uint8 | 本组信息类型<br/>0：视频片段信息<br/>2：抓拍信息<br/>抓拍文件总是2 |
| 0x01 | 7 | NA | 不明，总是`0x00` |
| 0x08 | 4 | uint32 | 时间戳，分段内第一张照片拍照时间 |
| 0x0C | 4 | NA | 不明，总是`0x00` |
| 0x10 | 4 | uint32 | 时间戳，分段内最后一张照片拍照时间 |
| 0x14 | 20 | NA | 不明，总是`0x00` |
| 0x28 | 4 | uint32 | 本分段中照片数据<sup>1</sup>在`hivXXXXX.mp4`文件中的开始位置（含）<br/>后文中称之为`seg_data_start_pos` |
| 0x2C | 4 | uint32 | 本分段在`hivXXXXX.mp4`文件中的结束位置（不含） |
| 0x30 | 1 | NA | 不明，通常是`0x01`，也可能是`0x00` |
| 0x31 | 7 | NA | 不明，总是`0x00` |
| 0x38 | 1 | uint8 | 分段内记录的最后一张照片：<br/>0x03：由语音“我要拍照”触发拍摄<br/>0x67：由停车监控下检测到震动触发拍摄 |
| 0x39 | 15 | NA | 不明，总是`0x00` |
| 0x48 | 4 | NA | 不明，总是`0x00 0x00 0x00 0x10` |
| 0x4C | 4 | NA | 不明，总是`0x00 0x00 0x00 0x10` |

<sup>1</sup> 在`hivXXXXX.mp4`文件中，在照片数据之前，还有4节总长度为`0x40000`的其他数据。详见[视频文件结构](./hiv_mp4_video.md)。

<br/><br/>
返回[SD卡根目录结构](./SD_card.md)
