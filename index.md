# indexXX.bin 文件结构

 `index00.bin`、`index01.bin`和`index02.bin`这三个文件的结构完全相同。根据目前对文件最后修改时间的观察，猜测`index00.bin`记录着最新的目录信息。开机时会把`index00.bin`备份至`index02.bin`。关机前，会把`index00.bin`备份到`index01.bin`。

即，取出SD卡用电脑读取时，`index00.bin`与`index01.bin`的内容相同，而`index02.bin`中存储的是过时的数据。因此，只需要分析记录最新数据的`index00.bin`。

index文件总体结构大致如下：

| 段数 | 作用 |
| ---- | ---- |
| 1 | 总体信息 |
| 2 | 每一个`hivXXXXX.mp4`记录文件总体信息 |
| 3 | 不明 |
| 4 | 每一个`hivXXXXX.mp4`记录文件中每一段视频/每一张抓拍的信息 |

## 第一段

本段位置固定为`0x0 - 0x3af`。在这一段中，按照长度`0x30`的内容为一节，分为19节。结构大致如下：

| 节数 | 主要包含信息 |
| ---- | ---- |
| 1 | `hivXXXXX.mp4`记录文件数量 |
| 2 | 当前写入的记录文件 |
| 3 | 记录抓拍的记录文件 |
| 4-19 | 空白 |

### 第1节 0x0 - 0x29

此节主要记录SD卡中共有多少个`hivXXXXX.mp4`记录文件。

| 偏移量 | 字节数 | 类型 | 猜测含义 |
| ---- | ---- | ---- | ---- |
| 0x00 | 4 | uint32 | 开箱后所有记录过的视频文件数量 |
| 0x04 | 8 | NA | 不明 |
| 0x0C | 2 | uint16 | SD卡目录中`hivXXXXX.mp4`文件数量 |
| 0x0E | 10 | NA | 不明 |
| 0x18 | 2 | NA | 不明，总是`0xFF 0xFF` |
| 0x1A | 22 | NA | 不明，总是`0x00` |

### 第2节 0x30 - 0x59

此节主要记录关机前正在写入的`hivXXXXX.mp4`文件编号`XXXXX`。

| 偏移量 | 字节数 | 类型 | 猜测含义 |
| ---- | ---- | ---- | ---- |
| 0x00 | 2 | uint16 | 关机时正在写入的视频文件编号`XXXXX` |
| 0x02 | 2 | NA | 不明，总是`0x00 0x00` |
| 0x04 | 4 | uint32 | 时间戳，该视频的开始时间 |
| 0x08 | 4 | uint32 | 时间戳，该视频的结束时间（即关机时间） |
| 0x0C | 12 | NA | 不明，总是`0x00` |
| 0x18 | 2 | NA | 不明，总是`0xFF 0xFF` |
| 0x1A | 22 | NA | 不明，总是`0x00` |

### 第3节 0x60 - 0x89

抓拍的照片会单独保存在一个`hivXXXXX.mp4`文件中。此节主要该抓拍记录文件的信息。

| 偏移量 | 字节数 | 类型 | 猜测含义 |
| ---- | ---- | ---- | ---- |
| 0x00 | 2 | uint16 | 用于记录抓拍的记录文件编号`XXXXX` |
| 0x02 | 2 | uint16 | 拍照数量 |
| 0x04 | 4 | uint | 时间戳，开箱后首次抓拍时间 |
| 0x08 | 4 | uint | 时间戳，最后一次抓拍的时间 |
| 0x0C | 4 | NA | 不明 |
| 0x10 | 2 | uint16 | 猜测为该文件支持的最大拍照数量 |
| 0x12 | 6 | NA | 不明，总是`0x00` |
| 0x18 | 2 | NA | 不明，总是`0xFF 0xFF` |
| 0x1A | 22 | NA | 不明，总是`0x00` |

### 第4-19节

这些节似乎没有被用到。

| 偏移量 | 字节数 | 类型 | 猜测含义 |
| ---- | ---- | ---- | ---- |
| 0x00 | 2 | NA | 不明，总是`0xFF 0xFF` |
| 0x02 | 22 | NA | 不明，总是`0x00` |
| 0x18 | 2 | NA | 不明，总是`0xFF 0xFF` |
| 0x1A | 22 | NA | 不明，总是`0x00` |

## 第二段

本段位置固定为`0x4b0 - 0x4ff`。含义不明。

| 偏移量 | 字节数 | 类型 | 猜测含义 |
| ---- | ---- | ---- | ---- |
| 0x00 | 76 | NA | 不明，总是`0x00` |
| 0x4C | 4 | uint32 | 不明，可能是视频总长度，以秒为单位 |

## 第三段

在这一段中，按照长度`0x20`为一节。每一节都对应了一个`hivXXXXX.mp4`记录文件。因为视频帧率、分辨率、HDR、SD卡容量等设置不同导致`hivXXXXX.mp4`记录文件数量也会不同。因此这一段的长度不固定。

例如，有234个`hivXXXXX.mp4`记录文件时，本段位置为0x500 - 0x223f。

本段大致结构如下：

| 节数 | 偏移量 | 长度 | 主要包含信息 |
| ---- | ---- | ---- | ---- |
| 1 | 0x00 | 0x20 | `hiv00000.mp4`记录文件信息 |
| 2 | 0x20 | 0x20 | `hiv00001.mp4`记录文件信息 |
| 3 | 0x40 | 0x20 | `hiv00002.mp4`记录文件信息 |
| ... | ... | 0x20 | ... |

至于其中长度为`0x20`的每一节，按照对应的记录文件是视频文件还是抓拍文件，内容含义有所不同。下面分类讨论。

### <span id="jump1">视频记录文件</span>

| 偏移量 | 字节数 | 类型 | 猜测含义 |
| ---- | ---- | ---- | ---- |
| 0x00 | 4 | uint32 | 对应的`hivXXXXX.mp4`文件序号`XXXXX` |
| 0x04 | 2 | uint16 | 0：未写入完成（如正在使用）<br/>1：写入完成 |
| 0x06 | 2 | uint16 | 文件中包含的视频片段数量-1 |
| 0x08 | 4 | uint32 | 时间戳，该视频文件的开始时间 |
| 0x0C | 4 | uint32 | 时间戳，该视频文件的结束时间 |
| 0x10 | 2 | uint16 | 此文件用来记录<br/>0：正常行车视频<br/>1：紧急录像<br/>2：当前正在写入的文件/抓拍文件 |
| 0x12 | 2 | NA | 不明 |
| 0x14 | 4 | NA | 不明，总是`0x00` |
| 0x18 | 4 | uint32 | 0x0：不明，常见<br/>0x2：不明，仅在紧急录像中出现<br/>0x64：按下紧急录像按钮开始的紧急录像 |
| 0x1C | 4 | NA | 不明，总是`0x00` |

### 抓拍记录文件

| 偏移量 | 字节数 | 类型 | 猜测含义 |
| ---- | ---- | ---- | ---- |
| 0x00 | 4 | uint32 | 对应的`hivXXXXX.mp4`文件序号`XXXXX` |
| 0x04 | 12 | NA | 不明，总是`0x00` |
| 0x10 | 2 | uint16 | 此文件用来记录<br/>0：正常行车视频<br/>1：紧急录像<br/>2：当前正在写入的文件/抓拍文件 |
| 0x12 | 14 | NA | 不明，总是`0x00` |

## 第四段

在这一段中，按照长度`0x5000`为一节。同样地，每一节对应了一个`hivXXXXX.mp4`记录文件。

在长度为`0x5000`的节中，按照长度`0x50`可以分为若干组。视频文件中，每一组对应文件中一段视频的信息；抓拍文件中，每一组对应一张抓拍文件的信息。

本段长度与位置不固定。例如有234个记录文件时，本节位置为0x2240 - 0x49423f

本段结构大致如下：

| 节数 | 偏移量 | 长度 | 组数 | 节内偏移量 | 长度 | 包含信息 |
| ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| 1 | 0x0000 | 0x5000 | 1 | 0x00 | 0x50 | `hiv00000.mp4`第1段视频信息 |
|  |  |  | 2 | 0x50 | 0x50 | `hiv00000.mp4`第2段视频信息 |
|  |  |  | 3 | 0xA0 | 0x50 | `hiv00000.mp4`第3段视频信息 |
|  |  |  | ... | ... | 0x50 | ... |
| 2 | 0x5000 | 0x5000 | 1 | 0x00 | 0x50 | `hiv00001.mp4`第1段视频信息 |
|  |  |  | 2 | 0x50 | 0x50 | `hiv00001.mp4`第2段视频信息 |
|  |  |  | 3 | 0xA0 | 0x50 | `hiv00001.mp4`第3段视频信息 |
|  |  |  | ... | ... | 0x50 | ... |
| ... | ... | 0x5000 | ... | ... | ... | ... |
| X | 0xXXXX | 0x5000 | 1 | 0x00 | 0x50 | `hivXXXXX.mp4`第1组抓拍信息 |
|  |  |  | 2 | 0x50 | 0x50 | `hivXXXXX.mp4`第2组抓拍信息 |
|  |  |  | 3 | 0xA0 | 0x50 | `hivXXXXX.mp4`第3组抓拍信息 |
|  |  |  | ... | ... | 0x50 | ... |
| ... | ... | 0x5000 | ... | ... | ... | ... |

### 视频记录文件

对应视频记录文件时，每一节内可按照长度0x50的内容为一组，对应了视频文件中的某一段录像的内容。

一个视频文件分为几段录像是因为某一文件的记录范围内可能多次开关机，有多个紧急录像，或者进入/离开停车监控模式。

对长度0x50的每一组：

| 偏移量 | 字节数 | 类型 | 猜测含义 |
| ---- | ---- | ---- | ---- |
| 0x00 | 1 | uint8 | 0：视频记录文件<br/>2：抓拍（不存在于视频记录文件中） |
| 0x01 | 1 | NA | 不明，通常为`0x00`，偶尔为`0x01` |
| 0x02 | 2 | NA | 不明，总是`0x00` |
| 0x04 | 4 | uint32 | 0x13：普通行车记录<br/>0x00：停车监控 |
| 0x08 | 4 | uint32 | 时间戳，视频片段开始时间 |
| 0x0C | 4 | NA | 不明，总是`0x00` |
| 0x10 | 4 | uint32 | 时间戳，视频片段结束时间 |
| 0x24 | 20 | NA | 不明，总是`0x00` |
| 0x28 | 4 | uint32 | 本片段在`hivXXXXX.mp4`文件中的开始位置（含）<br/>视频片段的开始位置总是与0x10000对齐 |
| 0x2C | 4 | uint32 | 本片段在`hivXXXXX.mp4`文件中的结束位置（不含） |
| 0x2D | 1 | NA | 不明，猜测<br/>0：本段自然结束<br/>1：本段因关机而结束 |
| 0x2E | 1 | uint8 | 录像帧率（fps）<br/>30：行车记录（可能因设置而不同）<br/>1：停车监控 |
| 0x2F | 1 | NA | 不明，猜测<br/>0x0：行车记录<br/>0x63：停车监控 |
| 0x30 | 1 | NA | 不明，总是`0x01` |
| 0x34 | 4 | NA | 不明，总是`0x00` |
| 0x38 | 4 | NA | 不明，通常为`0x00`，偶尔为`0x64`或`0x02` |
| 0x3C | 12 | NA | 不明，总是`0x00` |
| 0x48 | 4 | NA | 不明，总是`0x00 0x00 0x00 0x10` |
| 0x4C | 4 | NA | 不明，总是`0x00 0x00 0x00 0x10` |

[在index文件第三段中提到过](#jump1)，第三段中记录了每一个视频文件中有几段录像（“文件中包含的视频片段数量-1”），但是此处的0x50长度的内容的数量可能多于前面的记录。这是由于对应的视频文件之前曾经记录过更多视频片段导致的。

例如，一个视频文件曾经记录过5段视频，则此处会留下5段记录。当这个视频文件被循环录像覆盖后，仅用来记录了1段录像。这时，index文件的此处第1组0x50长度的信息为最新1段覆盖后的视频的信息。之后的4组为已经被覆盖过的无效信息，应无视掉。

### 抓拍记录文件

与视频记录文件对应的结构类似，仍然是以0x50为一组，但此处每一组对应一组抓拍图片。一组照片中至少由一张照片。

对0x50长度的每一组：

| 偏移量 | 字节数 | 类型 | 猜测含义 |
| ---- | ---- | ---- | ---- |
| 0x00 | 1 | uint8 | 0：视频记录文件（不存在于抓拍记录文件中）<br/>2：抓拍 |
| 0x01 | 7 | NA | 不明，总是`0x00` |
| 0x08 | 4 | uint32 | 时间戳，本组第一张照片拍照时间 |
| 0x0C | 4 | NA | 不明，总是`0x00` |
| 0x10 | 4 | uint32 | 时间戳，本组最后一张照片拍照时间 |
| 0x14 | 20 | NA | 不明，总是`0x00` |
| 0x28 | 4 | uint32 | 本组照片在`hivXXXXX.mp4`文件中的开始位置（含）<br/>开始位置总是与0x10000对齐 |
| 0x2C | 4 | uint32 | 本组照片在`hivXXXXX.mp4`文件中的结束位置（不含） |
| 0x2D | 1 | NA | 不明，通常是`0x01`，也可能是`0x00` |
| 0x34 | 7 | NA | 不明，总是`0x00` |
| 0x35 | 1 | NA | 不明，通常是`0x67`，也可能是`0x03` |
| 0x44 | 15 | NA | 不明，总是`0x00` |
| 0x48 | 4 | NA | 不明，总是`0x00 0x00 0x00 0x10` |
| 0x4C | 4 | NA | 不明，总是`0x00 0x00 0x00 0x10` |
